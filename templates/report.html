{% extends "layout.html" %}

{% block title %}分析报告 - {{ report_title }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    .report-container {
        background-color: #fff;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    .report-container h1, .report-container h2, .report-container h3 {
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-top: 20px;
    }
    .report-container h1 {
        font-size: 2.2em;
        margin-bottom: 20px;
    }
     .report-container h2 {
        font-size: 1.8em;
        margin-bottom: 15px;
    }
    .report-container h3 {
        font-size: 1.5em;
    }
    .report-container p {
        line-height: 1.8;
        color: #555;
    }
    .report-container strong {
        color: #000;
    }
    .report-container ul, .report-container ol {
        padding-left: 20px;
    }
    .report-container table {
        width: 100%;
        margin-bottom: 1rem;
        color: #212529;
        border-collapse: collapse;
    }
    .report-container th, .report-container td {
        padding: 0.75rem;
        vertical-align: top;
        border-top: 1px solid #dee2e6;
    }
    .report-container thead th {
        vertical-align: bottom;
        border-bottom: 2px solid #dee2e6;
        background-color: #f8f9fa;
    }
    .report-container tbody tr:nth-of-type(odd) {
        background-color: rgba(0,0,0,.03);
    }
    .report-container pre {
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
    }
    .report-container code {
        font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: .875em;
        color: #d63384; /* A bit of color for inline code */
    }
    .report-container pre code {
        color: inherit; /* Code inside pre should inherit pre's color or be styled by highlight.js */
        font-size: inherit;
        background-color: transparent;
        padding: 0;
        border-radius: 0;
    }
    .download-buttons {
        margin-top: 30px;
        margin-bottom: 20px;
        text-align: right;
    }
    .download-buttons .btn {
        margin-left: 10px;
    }

    /* Risk level styling */
    .risk-high { color: #dc3545; font-weight: bold; }
    .risk-medium { color: #ffc107; font-weight: bold; }
    .risk-low { color: #28a745; font-weight: bold; }

</style>
{% endblock %}

{% block content %}
<div class="report-container">
    {% if error_message %}
        <div class="alert alert-danger">
            <h1>错误</h1>
            <p>{{ error_message }}</p>
            <a href="{{ url_for('index') }}" class="btn btn-primary mt-3">返回上传页面</a>
        </div>
    {% else %}
        <div class="download-buttons">
            <a href="{{ url_for('download_report', report_filename=report_filename_raw, format='md') }}" class="btn btn-outline-secondary btn-sm">下载Markdown</a>
            <a href="{{ url_for('download_report', report_filename=report_filename_raw, format='pdf') }}" class="btn btn-outline-danger btn-sm">下载PDF</a>
            <!-- <a href="{{ url_for('download_report', report_filename=report_filename_raw, format='html') }}" class="btn btn-outline-info btn-sm">下载HTML</a> -->
        </div>

        <div id="report-content-markdown" style="display:none;">{{ report_content_md | safe }}</div>
        <div id="report-content-html">
            <!-- Content will be rendered here by Marked.js -->
        </div>

        <hr>
        <div class="mt-4">
            <a href="{{ url_for('index') }}" class="btn btn-primary">&laquo; 返回进行新的分析</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const markdownContent = document.getElementById('report-content-markdown').textContent;
        if (markdownContent) {
            // Configure marked to use highlight.js for code blocks
            marked.setOptions({
                renderer: new marked.Renderer(),
                highlight: function(code, lang) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                },
                pedantic: false,
                gfm: true,
                breaks: false,
                sanitize: false, // Be careful with this. If MD content is user-generated and not trusted, set to true.
                smartLists: true,
                smartypants: false,
                xhtml: false
            });

            const htmlContent = marked.parse(markdownContent);
            const reportDiv = document.getElementById('report-content-html');
            reportDiv.innerHTML = htmlContent;

            // Add Bootstrap table classes to tables generated by marked
            reportDiv.querySelectorAll('table').forEach(function(table) {
                table.classList.add('table', 'table-bordered', 'table-striped');
            });

            // Style risk levels if they appear in text (simple version)
            // For a more robust solution, specific spans/classes should be in the MD
            ['高风险', '中风险', '低风险'].forEach(risk => {
                let className = '';
                if (risk === '高风险') className = 'risk-high';
                else if (risk === '中风险') className = 'risk-medium';
                else if (risk === '低风险') className = 'risk-low';

                if (className) {
                    reportDiv.innerHTML = reportDiv.innerHTML.replace(
                        new RegExp(risk, 'g'),
                        `<span class="${className}">${risk}</span>`
                    );
                }
            });


        } else {
            // Handle case where report_content_md might be empty or null
             const reportDiv = document.getElementById('report-content-html');
             if (!reportDiv.querySelector('.alert-danger')) { // Don't overwrite existing error
                reportDiv.innerHTML = "<p class='text-muted'>报告内容为空或加载失败。</p>";
            }
        }
    });
</script>
{% endblock %}
